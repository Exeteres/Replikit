# Ядро

`@replikit/core` - модуль, без которого не будет работать ни одно Replikit-приложение.
Он отвечает за запуск контроллеров, предоставляет системы конфигурации и хуков.
Все интерфейсы, используемые или реализуемые контроллерами также объявлены в этом модуле.

## События

Одна из главных задач ядра - обработка событий, получаемых от контроллеров.
Для этого используется один единственный обработчик, который задается функцией `setHandler`.
Как правило, этот обработчик автоматически устанавливается и используется пакетом `@replikit/router`.

## Конфигурация

В ядре также располагается централизованная система конфигурации для различных модулей.
Для её обновления существует функция `updateConfig`, которая рекурсивно применит изменения из полученного объекта и вызовет хук `core:settings:update`.

```ts
import { updateConfig, config } from "@replikit/core";

updateConfig({
    mymodule: {
        field: "value"
    }
});

console.log(config.mymodule.field);
```

## Логирование

Логирование осуществляется экземплярами логгера, каждый из которых может иметь свою область видимости.

```ts
import { createScope } from "@replikit/core";

// Создаем область видимости mymodule
const logger = createScope("mymodule");
logger.info("Hi!");
```

Результат:

```
[INF] [XXXX-XX-XX GMTXXX:XX XX:XX:XX] [mymodule] Hi!
```

Области видимости также могут быть вложенными:

```ts
import { createScope } from "@replikit/core";

const logger = createScope("mymodule");

// Создаем область видимости submodule внтури mymodule
const nestedLogger = logger.createScope("submodule");
nestedLogger.info("Hi from submodule!");
```

Результат:

```
[INF] [XXXX-XX-XX GMTXXX:XX XX:XX:XX] [mymodule] [submodule] Hi from submodule!
```

## Хуки

Система хуков позволяет модулям выполнять код на различных этапах как загрузки ядра, так и его использования.
Обработчики хуков могут быть асинхронными. Они выполняются независимо друг от друга.

```ts
import { hook } from "@replikit/core";

hook("core:startup:init", () => {
    // Будет вызван перед загрузкой ядра
    console.log("init")
});

hook("core:startup:ready", () => {
    // Будет вызван когда ядро готово обрабатывать сообщения
    console.log("ready")
});

```

Для вызова хуков существует метод `invokeHook`, однако вы никогда не должны самостоятельно вызывать хуки сторонних модулей.
Это может нарушить работу всей системы.

Хуки ядра:

| Хук                    | Описание                                                                                  |
| ---------------------- | ----------------------------------------------------------------------------------------- |
| `core:startup:init`    | Начало процесса запуска                                                                   |
| `core:startup:done`    | Запуск завершился, но контроллеры еще не запущены                                         |
| `core:startup:ready`   | Ядро готово обрабатывать сообщения                                                        |
| `core:shutdown:init`   | Начало процесса завершения                                                                |
| `core:shutdown:done`   | Вызывается перед завершением процесса                                                     |
| `core:settings:update` | Конфигурация обновилась; обработчики получают копию старой конфигурации первым аргументом |

Хуки других модулей:

| Хук                      | Описание                           |
| ------------------------ | ---------------------------------- |
| `storage:database:init`  | Вызывается перед подключением к бд |
| `storage:database:done`  | Вызывается после подключения       |
| `storage:database:ready` | Хранилище готово к использованию   |
